<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>武陵高精度発電制御</title>
  <link rel="stylesheet" href="/WLBatterySimulator/static/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist-min@2.30.0/plotly.min.js"></script>
  <script src="https://unpkg.com/htmx.org@2.0.4"></script>
</head>
<body>
  <header class="container">
    <h1>武陵発電制御計算機</h1>
    <p class="muted">必要電力（5〜1595 / 5刻み）を入力すると、最適な設定値とチャートを表示します。</p>
  </header>

  <main class="container grid">
    <section class="card">
      <h2>発電値計算</h2>
      <form class="form"
        hx-post = "/WLBatterySimulator/calculate"
        hx-swap = "none"
        hx-encoding = "multipart/form-data"
      >
        <label>必要な発電量を入力してください</label>
        <input name="required_power" type="number" min="5" max="1595" step="5" required
                placeholder="例: 250" value="{{ required_power if required_power is not none else '' }}"/>
        
        <label>残電量安全マージン</label>
        <input name="storage_margin" type="number" min="0" max="100000" step="1000"  required
                placeholder="例: 10000" value="{{ storage_margin if storage_margin is not none else '10000' }}"/>
        <!-- 追加：5分割以下のみマージン適用トグル -->
        <label class="toggle">
          <span class="toggle-label">5分割以下のみマージン適用</span>

          <input type="checkbox" name="use_margin_under_5" {% if use_margin_under_5 %}checked{% endif %}/>
          <span class="toggle-track" aria-hidden="true">
            <span class="toggle-thumb"></span>
          </span>
        </label>
        <button type="submit">最適設定を計算</button>
      </form>
      <div id="error" class="error" hidden="true">
        {% include "/error.html" %}
      </div>

      <div id="result" class="result" hidden = "true">
        {% include "/result.html" %}
      </div>

    </section>
    <section class="card">
      <h2>制御回路図(入力1.5/min)</h2>
      <div class="code-row">
        <label class="muted">
          コード: <span id="codeValue">EFO01iUIAE8OIE29i72U4</span>
        </label>
        <button type="button" class="copy-btn" id="copyBtn">コピー</button>
      </div>
      <div id="toast" class="toast" role="status" aria-live="polite">コピー完了しました</div>
      <script>
        const codeValue = document.getElementById("codeValue");
        const copyBtn = document.getElementById("copyBtn");
        const toast = document.getElementById("toast");
        let toastTimer;

        function showToast(message = "コピー完了しました") {
          toast.textContent = message;
          toast.classList.add("show");

          clearTimeout(toastTimer);
          toastTimer = setTimeout(() => {
            toast.classList.remove("show");
          }, 1400);
        }

        copyBtn.addEventListener("click", async () => {
          const text = codeValue.textContent.trim(); // ←「コード: 」抜きでここだけ
          await navigator.clipboard.writeText(text);
          showToast("コピー完了しました");
        });
      </script>
      <img class="blueprint" src="/WLBatterySimulator/static/blueprint.png" alt="発電制御器 設計図" />
    </section>
    <script>
      async function renderBatteryChart(cardEl) {
        const chartDiv = cardEl.querySelector('#chart');

        // result が無いときは何もしない（chart.html が <p> のみ等）
        if (!chartDiv) return;

        const labels = JSON.parse(chartDiv.dataset.labels || '[]');
        const values = JSON.parse(chartDiv.dataset.values || '[]');

        // Plotlyのデータ
        const data = [{
          x: labels,
          y: values,
          type: 'scatter',
          mode: 'lines',
          line: { width: 2 },
          hovertemplate: '時間（分）=%{x}<br>残電量=%{y}<extra></extra>',
        }];

        const brightText = 'rgba(255,255,255,0.92)';  // 文字（明るく）
        const brightText2 = 'rgba(255,255,255,0.75)'; // 補助（少し薄く）
        const grid = 'rgba(255,255,255,0.10)';        // 薄いグリッド

        const layout = {
        margin: { l: 60, r: 20, t: 10, b: 60 },

        // 背景を透明に（カードの背景に馴染ませる）
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',

        font: {
          color: brightText2,
          size: 13,
        },

        // 軸ラベル
        xaxis: {
          title: { text: '時間（分）' },

          // 枠線っぽさを消す
          showline: false,      // 軸の太線（下線）を消す
          zeroline: false,      // ゼロ線を消す
          showgrid: true,       // グリッドは薄く出す（不要なら false）
          gridcolor: 'rgba(0,0,0,0.08)',
          ticks: 'outside',
          tickcolor: 'rgba(0,0,0,0.15)',
        },

        yaxis: {
          title: { text: '残電量' },
          rangemode: 'tozero',
          showline: false,
          zeroline: false,
          showgrid: true,
          gridcolor: 'rgba(0,0,0,0.08)',
          ticks: 'outside',
          tickcolor: 'rgba(0,0,0,0.15)',
        },
      };

      const config = {
        responsive: true,
        displayModeBar: false, // 右上のツールバーを消してスッキリ
      };
        if (chartDiv._fullLayout) {
          Plotly.purge(chartDiv);
        }
      await Plotly.newPlot(chartDiv, data, layout, config);
    }
          

    // 初回表示時
    document.addEventListener('DOMContentLoaded', () => {
      const card = document.querySelector('#tvChart');
      if (card) renderBatteryChart(card);
    });

    // htmx による部分更新後
    document.body.addEventListener('htmx:afterSettle', (evt) => {
      const swapped = evt.target;
      if (swapped.id === 'tvChart') {
        renderBatteryChart(swapped);
      }
    });
  </script>
  <section id="tvChart" class="card full">
    {% include "/chart.html" %}
  </section>

  </main>

  <footer class="container muted">
    <small>© 2026 holmesfems. MIT License:
      <a class="muted" href="https://licenses.opensource.jp/MIT/MIT.html" target="_blank" rel="noopener noreferrer">
        https://licenses.opensource.jp/MIT/MIT.html
      </a></small>
  </footer>
</body>
</html>